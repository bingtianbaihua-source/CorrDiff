## Context
项目为分子生成扩散模型。目标是在不重新训练扩散模型的前提下，显式建模属性相关性并实现可控多目标优化。

## Goals / Non-Goals
- Goals:
  - 学习解耦的潜在表示并分离共享结构与属性专属因素
  - 在潜在空间中引入主干-分支扩散以支持独立控制
  - 显式学习属性相关性并用于分支交互与引导融合（分子图/口袋图输入）
  - 通过训练自由引导实现多目标优化与约束冻结
  - 提供可复现的评估与验证流程
  - 训练时评估属性专家网络 R2
  - 离线补齐缺失属性标签并缓存
- Non-Goals:
  - 不更改现有数据集协议或重新定义分子表示标准
  - 不要求为每个新目标重新训练扩散模型

## Decisions
- Decision: 采用解耦 VAE 生成 z_shared 与 {z_pi}
  - Why: 为属性级别控制与引导提供正交潜在空间
- Decision: 主干-分支扩散结构生成 z_shared 与各属性分支
  - Why: 将共享结构生成与属性维度控制解耦
- Decision: 引入相关性图模块预测 C 并用于分支交互掩码
  - Why: 显式建模属性相关性与冲突，降低负迁移
- Decision: 训练自由能量引导仅作用于对应属性分支
  - Why: 避免多目标梯度相互干扰
- Decision: 相关性感知引导合并/分离策略 + 帕累托选择
  - Why: 在相关目标上协同优化，在冲突目标上维持独立性
- Decision: 离线计算缺失属性并缓存到数据集
  - Why: 训练期不引入外部预测开销，保证复现与一致性

## Risks / Trade-offs
- 风险: C 的学习不稳定或引入偏差
  - Mitigation: 采用温度/正则化与稀疏约束，评估与真实相关性对齐
- 风险: 分支扩散导致采样速度下降
  - Mitigation: 共享主干特征缓存，支持分支并行推理
- 风险: 解耦不足导致属性泄漏
  - Mitigation: 增强总相关/互信息惩罚并加入干预验证
- 风险: 外部属性预测误差影响训练信号
  - Mitigation: 记录预测来源与不确定性，评估 R2 并设定阈值

## Migration Plan
- 逐步引入：先实现离线属性补齐与解耦 VAE，再接入分支扩散与相关性模块，最后加入引导与评估

## Open Questions
- 训练/采样的默认属性权重与阈值如何设定
- 对接评分工具的具体调用路径与可用性
