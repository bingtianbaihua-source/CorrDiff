# DisenMoOD — Stage 1: DisentangledVAE 真实数据预训练
#
# 用法：
#   PYTHONPATH=. python scripts/train_vae.py \
#     --config configs/vae_real_data_config.yml \
#     --output checkpoints/vae.pt \
#     --logdir logs/vae \
#     --val-freq 1 \
#     --save-freq 10
#
# 断点续训：
#   PYTHONPATH=. python scripts/train_vae.py \
#     --config configs/vae_real_data_config.yml \
#     --output checkpoints/vae.pt \
#     --ckpt logs/vae/<run>/checkpoints/best.pt \
#     --logdir logs/vae
#
# 说明：
#   - data.path 非空 → 自动切换为真实数据模式（get_dataset + torch_geometric DataLoader）
#   - ligand_atom_feature_full 为整数索引，脚本内部自动 one-hot 编码为 (N, 13)
#   - protein_atom_feature_dim = 27 由 FeaturizeProteinAtom 固定，无需手动设置
#   - ligand_atom_feature_dim  = 13 由 add_aromatic 模式固定，无需手动设置
#   - 本 config 的 model.* 结构必须与 disenmood_training.yml 完全一致

# 指定 GPU
device: cuda:0

# ── 数据集 ──────────────────────────────────────────────────────────────────
data:
  name: pl_chem                        # pl_chem | pdbbind
  # ↓ 替换为实际路径
  path: data/crossdocked_v1.1_rmsd1.0_pocket10_processed_final_with_all_property.lmdb
  split: /data/crossdocked_pocket10_pose_split_all_property.pt
  transform:
    ligand_atom_mode: add_aromatic     # 决定 ligand_vocab_size=13
    random_rot: false

# ── 训练超参 ─────────────────────────────────────────────────────────────────
train:
  seed: 42
  epochs: 100           # 真实数据集推荐 50-200 epoch；CrossDocked 训练集约 10 万条
  batch_size: 32        # 显存不足改 16；drop_last=True 保证每批 ≥2 条
  num_workers: 4
  lr: 1.0e-3
  weight_decay: 1.0e-5
  max_grad_norm: 1.0    # 梯度裁剪阈值

# ── 模型结构（与 disenmood_training.yml 保持完全一致）────────────────────────
model:
  # 编码器
  hidden_dim: 128
  num_layers: 4
  edge_feat_dim: 4
  num_r_gaussian: 20
  knn: 32
  r_max: 10.0
  cutoff_mode: knn
  act_fn: silu
  norm: false
  update_x: false

  # 隐变量维度（Stage 2 config 须使用相同值）
  z_shared_dim: 64
  z_pi_dim: 32

  # 属性分支（与数据集标注属性对齐）
  property_names: ["affinity", "qed", "sa"]

  # 解缠损失权重
  beta_kl: 1.0          # KL 散度（β-VAE）
  tc_weight: 0.5        # 总相关性惩罚（off-diagonal covariance）
  mi_weight: 0.5        # z_shared 与 z_pi 的互信息惩罚

  # 相关矩阵模块
  enable_correlation_matrix: true
  corr_hidden_dim: 128
  corr_num_layers: 2
  corr_norm: false
  corr_act_fn: silu
  corr_threshold: 0.5
  corr_branch_interaction_strength: 0.1

  # 解码器（用于 VAE 重建 loss；与配体大小分布匹配）
  decoder_num_atoms: 30
  decoder_atom_types: [6, 7, 8, 9, 15, 16, 17]   # C N O F P S Cl
